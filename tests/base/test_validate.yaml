# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2025 Ilia Sotnikov
---
# Validation for tests
substitutions:
  # Condition to determine test success, should be lambda code returning bool
  success_condition:
  # Same but for considering the test as completed, in addition to timeout
  # below
  terminal_condition:
  # How long to wait for the terminal condition
  validation_timeout: 0s

esphome:
  on_boot:
    # Perform the validation of the results
    - then:
        # Wait for terminal condition or timeout
        - wait_until:
            condition:
              lambda: '${terminal_condition}'
            timeout: ${validation_timeout}
        # Determine the test result based on the success condition
        - if:
            condition:
              lambda: '${success_condition}'
            then:
              - logger.log:
                  format: TEST PASSED
                  level: INFO
              # Signal success by exiting with 0 code
              - lambda: exit(0);
            else:
              - logger.log:
                  format: TEST FAILED
                  level: ERROR
              # Signal failure by exiting with 1 code
              - lambda: exit(1);
